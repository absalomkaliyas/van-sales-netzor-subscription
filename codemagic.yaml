workflows:
  android-production-build:
    name: Android Production Build (Expo SDK 51)
    max_build_duration: 120
    instance_type: mac_mini_m2
    environment:
      groups:
        - expo_secrets
      vars:
        EXPO_PUBLIC_SUPABASE_URL: $EXPO_PUBLIC_SUPABASE_URL
        EXPO_PUBLIC_SUPABASE_ANON_KEY: $EXPO_PUBLIC_SUPABASE_ANON_KEY
        # Memory boost for Gradle 8+
        GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx6g -Dfile.encoding=UTF-8"
      node: 20
      java: 17
    scripts:
      - name: Install Dependencies & Fix Versions
        script: |
          cd mobile-app
          # Install current package.json dependencies
          npm install --legacy-peer-deps
          
          # Force update Expo dependencies to match SDK 51 requirements
          # This fixes the expo-modules-core incompatibility by pulling the latest patch version
          echo "üîß Fixing Expo dependency versions..."
          npx expo install --fix
          
          # Verify expo-modules-core version
          echo "üì¶ Checked expo-modules-core version:"
          npm list expo-modules-core
          
      - name: Prebuild Android (Generate Native Code)
        script: |
          cd mobile-app
          # Delete old android folder to ensure clean SDK 51 generation
          rm -rf android
          # Clean prebuild ensures fresh config
          npx expo prebuild --platform android --clean
          
          # Verify plugin is available via settings.gradle
          if [ -f "android/settings.gradle" ]; then
            echo "Checking settings.gradle for expo-modules-core..."
            if grep -q "expo-modules-core" android/settings.gradle; then
              echo "‚úÖ expo-modules-core found in settings.gradle"
            else
              echo "‚ö†Ô∏è expo-modules-core NOT found in settings.gradle"
              echo "expo prebuild should have added autolinking"
              echo "First 50 lines of settings.gradle:"
              head -50 android/settings.gradle
            fi
          fi
          
          # Verify expo-modules-core is installed
          if [ ! -d "node_modules/expo-modules-core" ]; then
            echo "‚ùå expo-modules-core not installed!"
            npm install expo-modules-core@~1.12.0
          fi
          
          # Check if gradle-plugin directory exists
          if [ ! -d "node_modules/expo-modules-core/android/gradle-plugin" ]; then
            echo "‚ùå gradle-plugin directory not found!"
            echo "Reinstalling expo-modules-core..."
            npm install expo-modules-core@~1.12.0 --force
          else
            echo "‚úÖ gradle-plugin directory exists"
          fi
          
          # Fix: Add plugin to buildscript classpath (required for plugin to be found)
          if [ -f "android/build.gradle" ] && [ -d "node_modules/expo-modules-core/android/gradle-plugin" ]; then
            echo "Checking if plugin is in buildscript classpath..."
            
            if ! grep -q "expo-modules-core.*gradle-plugin" android/build.gradle; then
              echo "‚ö†Ô∏è Plugin not in buildscript - adding it..."
              
              # Find the buildscript dependencies block
              if grep -q "buildscript" android/build.gradle && grep -q "dependencies {" android/build.gradle; then
                # Get the last classpath line number
                LAST_CLASSPATH=$(grep -n "classpath" android/build.gradle | tail -1 | cut -d: -f1)
                
                if [ -n "$LAST_CLASSPATH" ]; then
                  # Calculate relative path from android/build.gradle to gradle-plugin
                  PLUGIN_RELATIVE_PATH="../node_modules/expo-modules-core/android/gradle-plugin"
                  
                  # Add the plugin as an included build classpath
                  # Use the correct syntax for Gradle 8+
                  PLUGIN_LINE="        classpath files(\"$PLUGIN_RELATIVE_PATH\")"
                  
                  # Insert after last classpath
                  sed -i.bak "${LAST_CLASSPATH}a\\
${PLUGIN_LINE}" android/build.gradle
                  
                  echo "‚úÖ Added plugin to buildscript classpath"
                else
                  # Find dependencies { line
                  DEPS_LINE=$(grep -n "dependencies {" android/build.gradle | head -1 | cut -d: -f1)
                  if [ -n "$DEPS_LINE" ]; then
                    PLUGIN_RELATIVE_PATH="../node_modules/expo-modules-core/android/gradle-plugin"
                    PLUGIN_LINE="        classpath files(\"$PLUGIN_RELATIVE_PATH\")"
                    sed -i.bak "${DEPS_LINE}a\\
${PLUGIN_LINE}" android/build.gradle
                    echo "‚úÖ Added plugin to buildscript classpath"
                  fi
                fi
              fi
            else
              echo "‚úÖ Plugin already in buildscript"
            fi
          fi
          
          # Also ensure plugin is applied in root build.gradle
          if [ -f "android/build.gradle" ]; then
            if ! grep -q "id.*expo-module-gradle-plugin" android/build.gradle; then
              echo "Adding plugin application..."
              # Find plugins block or add it
              if grep -q "plugins {" android/build.gradle; then
                # Add to existing plugins block
                PLUGINS_LINE=$(grep -n "plugins {" android/build.gradle | head -1 | cut -d: -f1)
                if [ -n "$PLUGINS_LINE" ]; then
                  sed -i.bak "${PLUGINS_LINE}a\\
    id 'expo-module-gradle-plugin'" android/build.gradle
                  echo "‚úÖ Added plugin to plugins block"
                fi
              else
                # Add plugins block at the top
                sed -i.bak '1i\
plugins {\
    id '\''expo-module-gradle-plugin'\''\
}\
' android/build.gradle
                echo "‚úÖ Added plugins block with plugin"
              fi
            else
              echo "‚úÖ Plugin already applied"
            fi
          fi
          
          # Show buildscript for verification
          if [ -f "android/build.gradle" ]; then
            echo "Buildscript section:"
            grep -A 30 "buildscript" android/build.gradle | head -35
            echo ""
            echo "Plugins section:"
            grep -A 10 "plugins {" android/build.gradle | head -15 || echo "No plugins block found"
          fi
          
      - name: Patch Expo Modules Core (Targeted Root Fix)
        script: |
          # Define the specific path where the error is occurring (Root of the repo)
          TARGET_FILE="$CM_BUILD_DIR/node_modules/expo-modules-core/android/ExpoModulesCorePlugin.gradle"
          
          echo "üìù Targeted Patching of: $TARGET_FILE"
          
          if [ -f "$TARGET_FILE" ]; then
            echo "‚úÖ Found file at root!"
            # create backup
            cp "$TARGET_FILE" "$TARGET_FILE.backup"
            # Comment out line 85 (or any line matching the buggy code)
            sed -i.bak 's/from components.release/\/\/ from components.release \/\/ PATCHED BY CI/g' "$TARGET_FILE"
            echo "‚úÖ Patched file successfully"
            grep "PATCHED BY CI" "$TARGET_FILE"
          else
            echo "‚ùå File not found at expected path: $TARGET_FILE"
            echo "Listing root node_modules/expo-modules-core to debug:"
            ls -R "$CM_BUILD_DIR/node_modules/expo-modules-core" || echo "Dir not found"
            exit 1
          fi
          
          # Also check mobile-app just in case
          TARGET_FILE_LOCAL="$CM_BUILD_DIR/mobile-app/node_modules/expo-modules-core/android/ExpoModulesCorePlugin.gradle"
          if [ -f "$TARGET_FILE_LOCAL" ]; then
             echo "üîß Also patching local instance: $TARGET_FILE_LOCAL"
             sed -i.bak 's/from components.release/\/\/ from components.release \/\/ PATCHED BY CI/g' "$TARGET_FILE_LOCAL"
          fi
          
      - name: Build Android APK (Gradle)
        script: |
          cd mobile-app/android
          chmod +x gradlew
          
          echo "üöÄ Starting Gradle Build..."
          
          # Run build using Gradle wrapper
          ./gradlew assembleRelease --no-daemon --stacktrace
          
    artifacts:
      - mobile-app/android/app/build/outputs/**/*.apk
