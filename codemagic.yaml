workflows:
  android-production-build:
    name: Android Production Build (Expo SDK 51)
    max_build_duration: 120
    instance_type: mac_mini_m2
    environment:
      groups:
        - expo_secrets
      vars:
        EXPO_PUBLIC_SUPABASE_URL: $EXPO_PUBLIC_SUPABASE_URL
        EXPO_PUBLIC_SUPABASE_ANON_KEY: $EXPO_PUBLIC_SUPABASE_ANON_KEY
        # Memory boost for Gradle 8+
        GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx6g -Dfile.encoding=UTF-8"
      node: 20
      java: 17
    cache:
      cache_paths:
        - $CM_BUILD_DIR/mobile-app/node_modules
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
    scripts:
      - name: Install Dependencies
        script: |
          cd mobile-app
          # Use npm install since package-lock.json might be missing
          npm install --legacy-peer-deps
          
      - name: Install Expo CLI
        script: |
          npm install -g @expo/cli@latest eas-cli@latest
          
      - name: Prebuild Android (Generate Native Code)
        script: |
          cd mobile-app
          # Clean prebuild to ensure new Gradle config is generated
          npx expo prebuild --platform android --clean
          
      - name: Build Android APK
        script: |
          cd mobile-app/android
          chmod +x gradlew
          
          echo "ðŸš€ Starting Gradle Build (SDK 51 + Gradle 8)..."
          
          # Clean build with stacktrace and info logging, capturing output
          ./gradlew assembleRelease --no-daemon --stacktrace --info > build.log 2>&1 || true
          
          # Check for failure string or non-zero exit in log
          if grep -q "BUILD FAILED" build.log; then
            echo ""
            echo "âŒ BUILD FAILED! EXTRACTING ERROR..."
            echo "=============================================================================="
            grep -A 20 "What went wrong:" build.log
            echo "------------------------------------------------------------------------------"
            grep -A 20 "> Task :.* FAILED" build.log
            echo "=============================================================================="
            echo "Bottom of log:"
            tail -n 50 build.log
            exit 1
          else
            echo "âœ… Build Success!"
            tail -n 20 build.log
          fi
          
    artifacts:
      - mobile-app/android/app/build/outputs/**/*.apk
      - mobile-app/android/build.log
