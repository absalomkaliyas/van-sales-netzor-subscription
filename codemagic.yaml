workflows:
  android-production-build:
    name: Android Production Build (Expo SDK 51)
    max_build_duration: 120
    instance_type: mac_mini_m2
    environment:
      groups:
        - expo_secrets
      vars:
        EXPO_PUBLIC_SUPABASE_URL: $EXPO_PUBLIC_SUPABASE_URL
        EXPO_PUBLIC_SUPABASE_ANON_KEY: $EXPO_PUBLIC_SUPABASE_ANON_KEY
        # Memory boost for Gradle 8+
        GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx6g -Dfile.encoding=UTF-8"
      node: 20
      java: 17
    scripts:
      - name: Install Dependencies
        script: |
          cd mobile-app
          # Use npm install to ensure all dependencies including expo-modules-core are present
          npm install --legacy-peer-deps
          
      - name: Install Expo CLI
        script: |
          npm install -g @expo/cli@latest
          
      - name: Prebuild Android (Generate Native Code)
        script: |
          cd mobile-app
          # Delete old android folder to ensure clean SDK 51 generation
          rm -rf android
          # Clean prebuild ensures fresh config
          npx expo prebuild --platform android --clean
          
      - name: Patch Expo Modules Core (Global Search)
        script: |
          echo "üìù Searching for buggy ExpoModulesCorePlugin.gradle recursively from ROOT..."
          
          # Go to CI root directory to search everywhere
          cd $CM_BUILD_DIR
          
          # Find EVERY instance of the file (including in root node_modules if hoisted)
          FOUND_FILES=$(find . -name "ExpoModulesCorePlugin.gradle" -type f)
          
          if [ -z "$FOUND_FILES" ]; then
            echo "‚ùå Still not found! Debugging filesystem..."
            echo "Current location: $(pwd)"
            echo "Directory structure:"
            ls -F
            echo "Checking mobile-app/node_modules:"
            ls -F mobile-app/node_modules/expo-modules-core || echo "mobile-app/node_modules/expo-modules-core missing"
            echo "Checking root node_modules:"
            ls -F node_modules/expo-modules-core || echo "root node_modules/expo-modules-core missing"
            exit 1
          fi
          
          for FILE in $FOUND_FILES; do
            echo "üîß Patching file: $FILE"
            # create backup
            cp "$FILE" "$FILE.backup"
            # Comment out line 85 (or any line matching the buggy code)
            sed -i.bak 's/from components.release/\/\/ from components.release \/\/ PATCHED BY CI/g' "$FILE"
            echo "‚úÖ Patched $FILE"
            grep "PATCHED BY CI" "$FILE"
          done
          
      - name: Build Android APK (Gradle)
        script: |
          cd mobile-app/android
          chmod +x gradlew
          
          echo "üöÄ Starting Gradle Build..."
          
          # Run build using Gradle wrapper
          ./gradlew assembleRelease --no-daemon --stacktrace
          
    artifacts:
      - mobile-app/android/app/build/outputs/**/*.apk
