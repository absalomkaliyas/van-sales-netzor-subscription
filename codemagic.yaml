workflows:
  android-workflow:
    name: Android Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - expo_secrets
      vars:
        EXPO_PUBLIC_SUPABASE_URL: $EXPO_PUBLIC_SUPABASE_URL
        EXPO_PUBLIC_SUPABASE_ANON_KEY: $EXPO_PUBLIC_SUPABASE_ANON_KEY
      node: 20
    scripts:
      - name: Install dependencies
        script: |
          cd mobile-app
          npm install
      - name: Install Expo CLI
        script: |
          npm install -g @expo/cli eas-cli
      - name: Fix dependencies
        script: |
          cd mobile-app
          npx expo install --fix
      - name: Install expo-modules-core
        script: |
          cd mobile-app
          npm install expo-modules-core@~1.11.0
          # Verify expo-modules-core is installed correctly
          if [ -d "node_modules/expo-modules-core" ]; then
            echo "‚úÖ expo-modules-core installed"
            if [ -f "node_modules/expo-modules-core/scripts/autolinking.gradle" ]; then
              echo "‚úÖ autolinking.gradle found"
            else
              echo "‚ö†Ô∏è autolinking.gradle not found, listing scripts directory:"
              ls -la node_modules/expo-modules-core/scripts/ 2>/dev/null || echo "scripts directory not found"
            fi
          else
            echo "‚ùå expo-modules-core not installed!"
          fi
      - name: Prebuild Android
        script: |
          cd mobile-app
          npx expo prebuild --platform android --clean
          # Verify settings.gradle was created correctly
          if [ -f "android/settings.gradle" ]; then
            echo "‚úÖ settings.gradle created"
            echo "First 30 lines of settings.gradle:"
            head -30 android/settings.gradle
          fi
      - name: Fix Expo Module Plugin Configuration
        script: |
          cd mobile-app
          # Verify expo-modules-core is installed
          if [ ! -d "node_modules/expo-modules-core/android" ]; then
            echo "Installing expo-modules-core..."
            npm install expo-modules-core@~1.11.0
          fi
          echo "‚úÖ expo-modules-core verified"
          
          # Fix root build.gradle to include expo-modules-core plugin in buildscript
          if [ -f "android/build.gradle" ]; then
            echo "Checking root build.gradle for expo-modules-core plugin..."
            
            # Check if buildscript exists
            if ! grep -q "buildscript" android/build.gradle; then
              echo "‚ö†Ô∏è No buildscript found in root build.gradle"
            else
              # Check if expo-modules-core is in dependencies
              if ! grep -q "expo-modules-core" android/build.gradle; then
                echo "‚ö†Ô∏è expo-modules-core not found in buildscript dependencies"
                echo "This might be normal - expo prebuild should handle it"
              else
                echo "‚úÖ expo-modules-core found in buildscript"
              fi
            fi
          fi
          
          # Fix ExpoModulesCorePlugin.gradle to remove release property error
          echo "Fixing ExpoModulesCorePlugin.gradle release property issue..."
          plugin_file="node_modules/expo-modules-core/android/ExpoModulesCorePlugin.gradle"
          if [ -f "$plugin_file" ]; then
            # Check if the problematic line exists
            if grep -q "components.release" "$plugin_file"; then
              echo "Found components.release - this might cause the error"
              # Try to comment it out or fix it
              sed -i '' 's/components\.release/components.getByName("release")/g' "$plugin_file" || true
              echo "‚úÖ Attempted to fix release property"
            fi
          fi
          
          # Also check clone directory
          clone_plugin="/Users/builder/clone/mobile-app/node_modules/expo-modules-core/android/ExpoModulesCorePlugin.gradle"
          if [ -f "$clone_plugin" ]; then
            if grep -q "components.release" "$clone_plugin"; then
              sed -i '' 's/components\.release/components.getByName("release")/g' "$clone_plugin" || true
              echo "‚úÖ Fixed clone directory plugin"
            fi
          fi
          
      - name: Patch ALL Expo Modules Gradle Files
        script: |
          echo "üîß Patching ALL Expo modules to remove useDefaultAndroidSdkVersions()..."
          
          # Function to patch a file
          patch_file() {
            local file="$1"
            if [ -f "$file" ]; then
              echo "Patching: $file"
              # Remove the problematic line
              sed -i '' '/useDefaultAndroidSdkVersions()/d' "$file"
              # Add SDK versions if missing
              if ! grep -q "compileSdkVersion" "$file"; then
                sed -i '' '/android {/a\
          compileSdkVersion 34\
          buildToolsVersion "34.0.0"' "$file"
              fi
              echo "‚úÖ Patched: $file"
            fi
          }
          
          # Find and patch ALL expo-* modules in all locations
          echo "Searching for all expo modules..."
          
          # Search in current directory
          find . -type f -path "*/expo-*/android/build.gradle" 2>/dev/null | while read file; do
            patch_file "$file"
          done
          
          # Search in mobile-app
          if [ -d "mobile-app" ]; then
            find mobile-app -type f -path "*/expo-*/android/build.gradle" 2>/dev/null | while read file; do
              patch_file "$file"
            done
          fi
          
          # Search in clone directory (Codemagic's working directory)
          if [ -d "/Users/builder/clone" ]; then
            find /Users/builder/clone -type f -path "*/expo-*/android/build.gradle" 2>/dev/null | while read file; do
              patch_file "$file"
            done
          fi
          
          # Also check common problematic modules explicitly
          for module in expo-asset expo-file-system expo-camera expo-location expo-sharing expo-constants; do
            for base in "." "mobile-app" "/Users/builder/clone"; do
              file="$base/node_modules/$module/android/build.gradle"
              patch_file "$file"
            done
          done
          
          echo "‚úÖ Finished patching all Expo modules"
          
      - name: Final Comprehensive Gradle Patch Before Build
        script: |
          echo "üîß Final comprehensive patch - removing useDefaultAndroidSdkVersions() from ALL expo modules..."
          
          # Find and patch ALL expo-* modules one more time before build
          find . -type f -path "*/expo-*/android/build.gradle" 2>/dev/null -exec sed -i '' '/useDefaultAndroidSdkVersions()/d' {} \;
          
          if [ -d "mobile-app" ]; then
            find mobile-app -type f -path "*/expo-*/android/build.gradle" 2>/dev/null -exec sed -i '' '/useDefaultAndroidSdkVersions()/d' {} \;
          fi
          
          if [ -d "/Users/builder/clone" ]; then
            find /Users/builder/clone -type f -path "*/expo-*/android/build.gradle" 2>/dev/null -exec sed -i '' '/useDefaultAndroidSdkVersions()/d' {} \;
          fi
          
          # Verify - count remaining instances
          remaining=$(find . mobile-app /Users/builder/clone -type f -path "*/expo-*/android/build.gradle" 2>/dev/null -exec grep -l "useDefaultAndroidSdkVersions()" {} \; 2>/dev/null | wc -l | tr -d ' ')
          if [ "$remaining" -gt 0 ]; then
            echo "‚ö†Ô∏è Warning: Still found $remaining files with useDefaultAndroidSdkVersions()"
            echo "Trying alternative method - commenting out..."
            find . -type f -path "*/expo-*/android/build.gradle" 2>/dev/null -exec sed -i '' 's/useDefaultAndroidSdkVersions()/\/\/ useDefaultAndroidSdkVersions() - removed/g' {} \;
            if [ -d "mobile-app" ]; then
              find mobile-app -type f -path "*/expo-*/android/build.gradle" 2>/dev/null -exec sed -i '' 's/useDefaultAndroidSdkVersions()/\/\/ useDefaultAndroidSdkVersions() - removed/g' {} \;
            fi
            if [ -d "/Users/builder/clone" ]; then
              find /Users/builder/clone -type f -path "*/expo-*/android/build.gradle" 2>/dev/null -exec sed -i '' 's/useDefaultAndroidSdkVersions()/\/\/ useDefaultAndroidSdkVersions() - removed/g' {} \;
            fi
          else
            echo "‚úÖ Verified: All useDefaultAndroidSdkVersions() removed"
          fi
          
          # Fix expo-module-gradle-plugin issue
          echo "üîß Ensuring expo-modules-core plugin is properly configured..."
          
          # Remove any incorrectly added autolinking lines that might cause errors
          if [ -f "mobile-app/android/settings.gradle" ]; then
            # Check if autolinking line exists and if the file actually exists
            if grep -q "expo-modules-core/scripts/autolinking" mobile-app/android/settings.gradle; then
              # Verify the file exists before keeping the line
              if [ ! -f "mobile-app/node_modules/expo-modules-core/scripts/autolinking.gradle" ]; then
                echo "‚ö†Ô∏è autolinking.gradle not found, removing incorrect autolinking line..."
                sed -i '' '/expo-modules-core\/scripts\/autolinking/d' mobile-app/android/settings.gradle
                sed -i '' '/Expo modules autolinking/d' mobile-app/android/settings.gradle
                echo "‚úÖ Removed incorrect autolinking line"
              else
                echo "‚úÖ autolinking.gradle exists, keeping autolinking line"
              fi
            fi
          fi
          
          # Also check clone directory
          if [ -f "/Users/builder/clone/mobile-app/android/settings.gradle" ]; then
            if grep -q "expo-modules-core/scripts/autolinking" /Users/builder/clone/mobile-app/android/settings.gradle; then
              if [ ! -f "/Users/builder/clone/mobile-app/node_modules/expo-modules-core/scripts/autolinking.gradle" ]; then
                echo "‚ö†Ô∏è Removing incorrect autolinking line from clone directory..."
                sed -i '' '/expo-modules-core\/scripts\/autolinking/d' /Users/builder/clone/mobile-app/android/settings.gradle
                sed -i '' '/Expo modules autolinking/d' /Users/builder/clone/mobile-app/android/settings.gradle
                echo "‚úÖ Removed incorrect autolinking line from clone"
              fi
            fi
          fi
          
          # expo prebuild should handle autolinking automatically
          # If it's missing, it means expo-modules-core wasn't properly installed
          echo "‚úÖ expo prebuild should have configured autolinking automatically"
          
      - name: Build APK
        script: |
          cd mobile-app/android
          chmod +x gradlew
          ./gradlew assembleRelease
    artifacts:
      - mobile-app/android/app/build/outputs/**/*.apk

